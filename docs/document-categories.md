# ドキュメントカテゴリ定義

> 合同会社型 DAO の定款・規程類のひな形構造に準拠したドキュメント分類体系
>
> **実装状況**: ✅ 実装完了（EAS v3 スキーマデプロイ済み、型定義・UI・テスト全て対応済み）

## 概要

本プラットフォームで扱うドキュメントは、大きく **規程類** と **その他ドキュメント** の 2 グループに分かれる。

| グループ               | 説明                                                                   |
| ---------------------- | ---------------------------------------------------------------------- |
| **規程類**             | DAO の法的・組織的ルールを定める文書。定款を頂点とし、各規程が補完する |
| **その他ドキュメント** | DAO の意思決定プロセスで発生する記録文書                               |

---

## 1. 規程類（Regulations）

合同会社型 DAO の基本文書体系。①〜④ が標準セットとして存在し、⑤ で拡張可能。

| #   | カテゴリ ID       | 日本語名     | 英語名                    | 説明                                                         |
| --- | ----------------- | ------------ | ------------------------- | ------------------------------------------------------------ |
| ①   | `articles`        | 定款         | Articles of Incorporation | DAO の最上位規範。組織の目的・構成・基本ルールを定める       |
| ②   | `assembly_rules`  | DAO総会規程  | General Assembly Rules    | DAO 総会の招集・議決・運営手続きを定める                     |
| ③   | `operation_rules` | 運営規程     | Operation Rules           | 日常の業務運営・役割分担・意思決定プロセスを定める           |
| ④   | `token_rules`     | トークン規程 | Token Rules               | ガバナンストークンの発行・配布・権利・移転ルールを定める     |
| ⑤   | `custom_rules`    | カスタム規程 | Custom Rules              | 上記に分類されない追加規程（例: 報酬規程、紛争解決規程など） |

### `custom_rules` の識別

`custom_rules` は複数登録可能なため、`documentType` だけでは区別できない。
`documentTitle` で識別する（例: 「報酬規程」「紛争解決規程」）。

- 同じ DAO 内で同一タイトルの `custom_rules` は重複登録不可（アプリ層で制限）
- 改定時は同タイトルのチェーンを辿る
- タイトルはユーザーが自由に設定（バリデーションは空文字チェックのみ）

### 規程類の特性

- **バージョン管理**: `previousVersionId` チェーンで改定履歴を追跡する
- **DAO に紐づく**: 必ず特定の DAO に所属する（`daoAttestationUID`）
- **ハッシュ検証**: 原本性を担保するためファイルハッシュを EAS にアンカリング
- **1 DAO につき各規程は原則 1 つ**（最新バージョンが有効）。`custom_rules` のみ複数可

---

## 2. その他ドキュメント（Other Documents）

DAO の意思決定プロセスで発生する文書。規程類とは性質が異なり、蓄積型で運用される。

| #   | カテゴリ ID | 日本語名 | 英語名          | 説明                                                   |
| --- | ----------- | -------- | --------------- | ------------------------------------------------------ |
| ⑥   | `proposal`  | 投票議題 | Voting Proposal | DAO 総会に提出される議案。投票トランザクションと紐づく |
| ⑦   | `minutes`   | 議事録   | Meeting Minutes | DAO 総会・会議の結果を記録する文書                     |

### その他ドキュメントの特性

- **蓄積型**: 1 DAO に対して複数存在する（会議ごと・議案ごとに作成）
- **投票議題は投票情報と紐づく**: `votingTxHash`, `votingChainId` フィールドを持つ
- **議事録は投票議題と紐づけ可能**: 関連する議題への参照を持てる

---

## 3. カテゴリ体系図

```
DAO
├── 規程類 (Regulations)
│   ├── ① 定款 (articles)                    ← 最上位規範、1つ
│   ├── ② DAO総会規程 (assembly_rules)        ← 総会ルール、1つ
│   ├── ③ 運営規程 (operation_rules)          ← 運営ルール、1つ
│   ├── ④ トークン規程 (token_rules)          ← トークンルール、1つ
│   └── ⑤ カスタム規程 (custom_rules)         ← 追加規程、複数可
│
└── その他ドキュメント (Other Documents)
    ├── ⑥ 投票議題 (proposal)                 ← 蓄積型、複数
    └── ⑦ 議事録 (minutes)                    ← 蓄積型、複数
```

---

## 4. 現行実装からの変更点

### カテゴリ ID の変更

| 旧 ID       | 旧ラベル                     | →   | 新 ID             | 新ラベル         |
| ----------- | ---------------------------- | --- | ----------------- | ---------------- |
| `articles`  | 定款                         | →   | `articles`        | 定款（変更なし） |
| `meeting`   | DAO総会規程 / 議事録（混在） | →   | `assembly_rules`  | DAO総会規程      |
| `operation` | 運営                         | →   | `operation_rules` | 運営規程         |
| `token`     | トークン                     | →   | `token_rules`     | トークン規程     |
| `voting`    | 投票ドキュメント             | →   | `proposal`        | 投票議題         |
| `other`     | その他                       | →   | `custom_rules`    | カスタム規程     |
| _(なし)_    | —                            | →   | `minutes`         | 議事録（新設）   |

### 主な変更理由

1. **`meeting` の分離**: 「DAO総会規程」（規程）と「議事録」（記録）は本質的に異なる文書。現行では UI ごとにラベルが不一致だった
2. **`_rules` サフィックス統一**: 規程類は `*_rules` の命名規則で統一し、グループ判別を容易にする（`articles` は慣例的にそのまま）
3. **`voting` → `proposal`**: 「投票」は行為であり文書カテゴリとしては「議題」が適切
4. **`other` → `custom_rules`**: 「その他」は曖昧。追加規程という明確な位置づけに変更
5. **`minutes` 新設**: 議事録は DAO 運営の重要な記録であり、独立カテゴリが必要

---

## 5. TypeScript 型定義（実装時の参考）

```typescript
// --- カテゴリ型 ---

type RegulationType =
  | 'articles' // 定款
  | 'assembly_rules' // DAO総会規程
  | 'operation_rules' // 運営規程
  | 'token_rules' // トークン規程
  | 'custom_rules'; // カスタム規程

type OtherDocumentType =
  | 'proposal' // 投票議題
  | 'minutes'; // 議事録

type DocumentType = RegulationType | OtherDocumentType;

// --- 定数 ---

const REGULATION_TYPES: RegulationType[] = [
  'articles',
  'assembly_rules',
  'operation_rules',
  'token_rules',
  'custom_rules',
];

const OTHER_DOCUMENT_TYPES: OtherDocumentType[] = ['proposal', 'minutes'];

const DOCUMENT_TYPE_LABELS: Record<DocumentType, string> = {
  articles: '定款',
  assembly_rules: 'DAO総会規程',
  operation_rules: '運営規程',
  token_rules: 'トークン規程',
  custom_rules: 'カスタム規程',
  proposal: '投票議題',
  minutes: '議事録',
};

// --- ドキュメントモデル ---
// version は EAS に含めない。previousVersionId チェーンの深さから算出し Firebase に保持。

interface Document {
  id: string; // EAS attestation UID
  daoId: string; // DAO attestation UID
  title: string;
  documentType: DocumentType;
  hash: string; // SHA-256
  ipfsCid: string;
  previousVersionId: string | null; // チェーン（初版は null）
  version: number; // 導出値（Firebase のみ。EAS にはない）
  status: 'active' | 'revoked';
  attester: string;
  votingTxHash: string | null; // proposal のみ
  votingChainId: number | null; // proposal のみ
  relatedDocumentIds: string[]; // 関連ドキュメント（Firebase のみ）
  createdAt: string;
  updatedAt: string;
}
```

---

## 6. マイグレーション考慮事項

既存データの `documentType` を新カテゴリ ID にマッピングする必要がある:

```
meeting   → assembly_rules  （規程として登録されたもの）
meeting   → minutes         （議事録として登録されたもの）※ 判別ロジック要検討
operation → operation_rules
token     → token_rules
voting    → proposal
other     → custom_rules
```

> **注意**: `meeting` → `assembly_rules` / `minutes` の振り分けは、既存データの内容を確認して判断する必要がある。自動判別が難しい場合は手動マイグレーションまたはデフォルトで `assembly_rules` にマッピングし、ユーザーに再分類を促す方式を検討。

---

## 7. バージョン管理の設計

### 設計原則：バージョンはユーザーが入力するものではない

バージョン番号はシステムが管理する**内部メタデータ**であり、ユーザーに手入力させてはならない。

**手動入力が破綻する理由:**

- 同じバージョン番号で何度も登録できる（`"1.0"` のまま 3 回登録 → 区別不可能）
- 表記揺れが発生する（`"v2"` / `"2.0"` / `"第2版"` — EAS 上で統一できない）
- `previousVersionId` と整合しないバージョン番号が入り得る
- そもそもバージョン番号の意味をユーザーが正しく理解している保証がない

**→ バージョン番号はフォームから削除する。**

### 設計原則：`version` は EAS スキーマに含めない

`version` フィールドはオンチェーンスキーマから除外すべき。

**理由:**

- バージョン番号は `previousVersionId` チェーンを辿れば**算出できる**（チェーンの深さ = バージョン番号）
- オンチェーンに冗長なデータを持つとガス代が増えるだけ
- 導出可能なデータをオンチェーンに焼くのはアンチパターン
- 表示用のバージョン番号は Firebase キャッシュ側で計算すれば十分

**バージョン番号の導出ロジック:**

```
previousVersionId === 0x00...00 → v1（初版）
previousVersionId !== 0x00...00 → 前バージョンの version + 1
```

### EAS v3 スキーマ（version フィールド削除）

```
bytes32 daoAttestationUID,    // 所属 DAO
string  documentTitle,        // 文書タイトル
string  documentType,         // カテゴリ ID（articles, assembly_rules, ...）
bytes32 documentHash,         // SHA-256 ハッシュ
string  ipfsCid,              // IPFS CID
bytes32 previousVersionId,    // 前バージョンの attestation UID（初版は 0x0）
bytes32 votingTxHash,         // 投票 TX ハッシュ（proposal のみ）
uint256 votingChainId         // 投票チェーン ID（proposal のみ）
```

**現行 v2 からの差分:** `version` (string) を削除のみ。

### カテゴリ別バージョン管理

#### 規程類（単一有効版モデル）

規程類は**1 DAO に対して各カテゴリ 1 つの有効版**が原則。改定時は自動的にチェーンされる。

```
定款 (attestation-uid-1) ─ previousVersionId: 0x0      → 表示: v1
    └── 定款 (attestation-uid-2) ─ previousVersionId: uid-1  → 表示: v2
            └── 定款 (attestation-uid-3) ─ previousVersionId: uid-2  → 表示: v3
```

**自動化される挙動:**

1. **previousVersionId の自動設定**
   - 改定時、同 DAO × 同カテゴリの最新ドキュメント UID を自動で `previousVersionId` にセット
   - 新規登録時は `0x0`

2. **バージョン番号の算出（表示用）**
   - Firebase キャッシュに `version` フィールドを持つ（表示用、導出値）
   - `previousVersionId` チェーンの深さから算出

3. **登録フローの分離**
   - **新規登録**: そのカテゴリに既存ドキュメントがない場合のみ許可（`custom_rules` は除く）
   - **改定登録**: 既存ドキュメント一覧から対象を選択 → 自動でチェーン構築

4. **重複防止**
   - `articles`, `assembly_rules`, `operation_rules`, `token_rules` は同 DAO 内で**有効なもの（active）が 1 つ**に制限
   - `custom_rules` は複数の異なる規程を登録可能（それぞれが独自のバージョンチェーンを持つ）

#### その他ドキュメント（蓄積モデル）

投票議題・議事録は蓄積型であり、バージョン管理の対象外。

| ドキュメント | バージョン管理 | previousVersionId | 説明                                         |
| ------------ | -------------- | ----------------- | -------------------------------------------- |
| **投票議題** | なし（単発）   | 常に `0x0`        | 各議案は独立。改定ではなく新規議案として登録 |
| **議事録**   | なし（単発）   | 常に `0x0`        | 各会議の記録は独立。修正時は revoke → 再登録 |

### 登録フロー概要

```
┌──────────────────────────────────────────────┐
│  ドキュメント登録                               │
│                                              │
│  ① カテゴリ選択                               │
│     ├── 規程類 → ② へ                        │
│     └── その他 → ⑤ へ                        │
│                                              │
│  ② 規程タイプ選択                              │
│     (articles / assembly_rules / ... )       │
│                                              │
│  ③ 新規 or 改定？                             │
│     ├── 新規 → 既存があれば警告/ブロック        │
│     └── 改定 → 既存の最新版を自動参照           │
│              previousVersionId: 自動セット     │
│                                              │
│  ④ ファイルアップロード + 確認 → EAS 登録      │
│                                              │
│  ⑤ その他ドキュメント                          │
│     (proposal / minutes)                     │
│     previousVersionId: 常に 0x0              │
│                                              │
│  ⑥ 確認 → EAS 登録                           │
└──────────────────────────────────────────────┘
```

### データ層の整理

| 項目                | EAS（オンチェーン）              | Firebase（キャッシュ）     |
| ------------------- | -------------------------------- | -------------------------- |
| `previousVersionId` | bytes32（正規データ）            | string（コピー）           |
| `version`           | **なし**（削除）                 | number（チェーンから算出） |
| バージョンチェーン  | `previousVersionId` を辿って構築 | 事前計算して保持           |

---

## 8. Revoke とバージョンチェーン

### Revoke の意味

EAS における revoke は attestation の無効化。ドキュメント文脈では「この文書は無効である」という宣言。

### ルール

| ケース                          | 挙動                                                                                                                                                                 |
| ------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **最新版を revoke**             | その規程カテゴリは「要再登録」状態になる。再登録でチェーン継続                                                                                                       |
| **旧版を revoke**               | アプリ層で禁止。revoke できるのは最新版のみ（チェーンの先端）。※ EAS プロトコル上は attester が任意の attestation を revoke 可能だが、アプリ側で最新版のみに制限する |
| **その他ドキュメントを revoke** | そのドキュメント単体が無効化される                                                                                                                                   |

### 最新版 revoke 後のバージョンチェーン

```
定款 v1 (active)
    └── 定款 v2 (active)
            └── 定款 v3 (revoked)  ← revoke された

→ 結果: 定款 v2 が「現行有効版」として復活するわけではない。
         定款カテゴリ自体が「要再登録」状態になる。
         再登録時は previousVersionId: v3 のUID でチェーンを継続。
```

**旧版を自動復活させない理由:**

- revoke は「この内容は誤りだった」という意味。旧版が正しいとは限らない
- 法的文書として、明示的に「この版が有効」と宣言する行為が必要
- 自動復活は意図しない文書が有効になるリスクがある

### revoke 後の再登録

revoke 後に改めて規程を有効にするには、新しいバージョンとして再登録する:

```
定款 v3 (revoked)
    └── 定款 v4 (active) ← 内容は v2 と同じでもよいが、新たな登録行為が必要
```

---

## 9. アクセス制御

### 権限モデル

ドキュメント操作の権限は **DAO の attester（作成者）のウォレットアドレス** を基準に制御する。

| 操作                 | 権限         | 説明                                     |
| -------------------- | ------------ | ---------------------------------------- |
| **ドキュメント登録** | DAO メンバー | DAO に所属するウォレットのみ             |
| **改定登録**         | DAO メンバー | 同上。元の登録者と異なってよい           |
| **Revoke**           | DAO メンバー | 最新版の revoke のみ許可                 |
| **閲覧**             | 誰でも       | EAS は public。Firebase キャッシュも公開 |
| **検証**             | 誰でも       | ハッシュ照合は誰でも可能                 |

### DAO メンバーの判定

現行はウォレット接続ベース。DAO 作成者のアドレスがメンバーとして扱われる。

> **将来的な拡張**: マルチシグやトークンゲーティングによる権限管理が考えられるが、Phase 0 ではシンプルなウォレットベースで十分。

### 操作ログ

すべてのドキュメント操作は EAS attestation として記録されるため、誰がいつ何をしたかは オンチェーンで追跡可能（`attester` フィールド）。

---

## 10. ドキュメント間の参照関係

### 必要な参照パターン

| 参照元     | → 参照先   | 用途                                 |
| ---------- | ---------- | ------------------------------------ |
| 議事録     | → 投票議題 | 「この議事録はこの議案の審議結果」   |
| 投票議題   | → 規程     | 「この議案は定款第X条の改定案」      |
| 改定版規程 | → 投票議題 | 「この改定はこの議案の可決に基づく」 |

### 実現方法

EAS v3 スキーマには参照フィールドを追加しない。理由:

- 参照関係はすべてのカテゴリに必要なわけではない
- スキーマを参照パターンごとに肥大化させたくない
- 参照関係は Firebase キャッシュ層で管理する

### Firebase での参照管理

```typescript
interface FirebaseDocumentData {
  // ... 既存フィールド
  relatedDocumentIds?: string[]; // 関連ドキュメントの attestation UID
}
```

- `relatedDocumentIds` はオフチェーンの補助情報として Firebase に保存
- UI で「関連ドキュメント」として表示
- オンチェーンの正規データではないため、参照整合性はベストエフォート

### 投票議題 → 規程の特殊な参照

投票議題で規程の改定が可決された場合、改定版規程の登録時に:

1. 投票議題の `attestationUID` を `relatedDocumentIds` に含める
2. これにより「どの議決に基づく改定か」を追跡可能

---

## 11. 第三者検証フロー

### 検証の目的

「この PDF ファイルが本当にこの DAO の正式な定款であるか」を、プラットフォーム外の第三者が確認できること。

### 検証手順

```
① 検証したい PDF ファイルを入手

② ファイルの SHA-256 ハッシュを計算
   $ sha256sum articles.pdf
   → e3b0c44298fc1c149afbf4c8996fb924...

③ EAS Explorer でハッシュを検索
   → documentHash が一致する attestation を発見

④ attestation の内容を確認
   - daoAttestationUID: どの DAO のドキュメントか
   - documentType: "articles" → 定款である
   - attester: 誰が登録したか
   - timestamp: いつ登録されたか
   - revoked: false → 現在有効

⑤ （任意）IPFS から原本をダウンロードして比較
   - ipfsCid でファイルを取得
   - ハッシュが一致すれば原本と同一
```

### プラットフォーム上の検証 UI

現行の `DocumentVerifier` コンポーネントを拡張:

1. ファイルをドラッグ＆ドロップ
2. SHA-256 を自動計算
3. EAS を検索して一致する attestation を表示
4. DAO 名・カテゴリ・登録日・有効/無効を表示

### オフライン検証の保証

EAS はパブリックチェーン上にあるため、プラットフォームが停止しても検証可能:

- EAS Explorer（公式ツール）でハッシュ検索可能
- etherscan 等でも attestation データを直接読める
- IPFS CID があればファイル自体も分散ストレージから取得可能

---

## 12. IPFS ピンニング戦略

### 現行の課題

ファイルを IPFS にアップロードしても、ピンニングしなければノードからガベージコレクトされる。

### ピンニング方針

| 層                 | 方法                                               | 責任                 |
| ------------------ | -------------------------------------------------- | -------------------- |
| **アップロード時** | Pinata / web3.storage 等のピンニングサービスを使用 | プラットフォーム     |
| **永続化**         | ピンニングサービスの有料プランで保持               | プラットフォーム運営 |
| **フォールバック** | Firebase Storage にバックアップコピーを保持        | プラットフォーム     |

### 可用性の考え方

```
ドキュメントの可用性保証:

EAS (attestation)  → 永続（ブロックチェーン上、消えない）
IPFS (ファイル本体) → ベストエフォート（ピンニング依存）
Firebase (キャッシュ) → プラットフォーム稼働中のみ

→ 最低限の保証: ハッシュによる真正性検証はいつでも可能
   ファイル本体の取得はピンニング維持に依存
```

### コスト考慮

- 法的文書（PDF）は通常数百 KB〜数 MB 程度
- DAO あたりの規程類は最大 5 種類 + α
- ピンニングコストは十分に低い（数百円/月程度）

---

## 13. ファイル形式・サイズ制限

### 許可するファイル形式

| 形式    | MIME タイプ       | 用途                             |
| ------- | ----------------- | -------------------------------- |
| **PDF** | `application/pdf` | 主要フォーマット。法的文書の標準 |

> **Phase 0 では PDF のみ**。理由:
>
> - 法的文書は PDF が事実上の標準
> - レンダリングの一貫性が保証される（Word はビューアーによって表示が変わる）
> - ハッシュの安定性（Word は保存のたびに内部メタデータが変わりうる）

### サイズ制限

| 制限                       | 値                  | 理由                                              |
| -------------------------- | ------------------- | ------------------------------------------------- |
| **1 ファイルあたりの上限** | 10 MB               | 法的文書として十分。IPFS アップロードの実用的上限 |
| **1 DAO あたりの総容量**   | 制限なし（Phase 0） | 蓄積型ドキュメントがあるため、総量制限は設けない  |

### バリデーション

ファイルアップロード時に以下を検証:

1. MIME タイプが `application/pdf` であること
2. ファイルサイズが 10 MB 以下であること
3. ファイルが破損していないこと（PDF パース可能であること）
