# v2 機能要件定義

> v2 で実装する機能の要件を、必須再実装・新機能・非機能要件に分けて定義する。

---

## 1. v1 再実装機能（必須）

### 1.1 認証・ウォレット

#### FR-AUTH-01: ウォレット接続認証

- MetaMask ウォレット接続を唯一の認証手段とする
- ウォレットアドレスがユーザーの一意な識別子
- 接続状態の永続化（Zustand + localStorage）
- v1との違い: localStorage 独自認証 → ウォレット接続に移行（Firebase Auth は不使用）

#### FR-AUTH-02: ウォレット接続

- MetaMask によるウォレット接続
- 接続状態の永続化（Zustand + localStorage）
- アカウント変更検知と自動ログアウト
- 複数ウォレット対応の拡張基盤（v2ではMetaMaskのみ）

#### FR-AUTH-03: ネットワーク管理

- Sepolia テストネットへの自動切替
- 未登録チェーンの自動追加
- 不正ネットワーク接続時の警告UI

#### FR-AUTH-04: 認証ガード

- 保護ルートへのウォレット未接続アクセス時に「ウォレットを接続してください」UIをインライン表示
- ウォレット接続ボタンを表示し、接続後に自動的にコンテンツを表示

---

### 1.2 DAO管理

#### FR-DAO-01: DAO一覧表示

- 全登録DAOの一覧表示
- GraphQL バッチクエリ + Firebase バッチ読み取りによるデータ取得（※詳細は architecture.md §6 参照）
- TanStack Query によるキャッシュ管理（staleTime: 60s）
- DAO名によるテキスト検索
- ステータスによるフィルター（active/inactive）
- ページネーション
- ローディングスケルトン表示
- 空状態の表示

#### FR-DAO-02: DAO詳細表示

- EAS + Firebase の統合データ表示
- UID 指定の単一リソースクエリ（v1 の全件取得 → フィルターを廃止）
- 表示項目: 名前、説明、所在地、メンバー数、ステータス、設立日、管理者アドレス、ウェブサイト
- 紐付きドキュメント一覧の表示
- EAS アテステーションUID の表示・コピー機能

#### FR-DAO-03: DAO作成

- ウォレット接続必須
- 入力項目:
  - DAO名（EAS に保存、必須）
  - 管理者アドレス（ウォレットから自動入力、読み取り専用）
  - 説明（Firebase、必須）
  - 所在地（Firebase、任意）
  - 初期メンバー数（Firebase、任意）
  - ロゴURL（Firebase、任意）
- 作成フロー（3ステップウィザード）:
  1. 基本情報入力: フォームバリデーション（Zod）
  2. 確認・署名: 入力内容確認 → Gas 見積もり表示 → ウォレットで署名 → EAS アテステーション作成
  3. 完了: 成功メッセージ + アテステーション UID 表示 → 作成した DAO 管理ページへリダイレクト
- 各ステップの進捗表示（トランザクション待機中）

#### FR-DAO-04: DAO編集

- 管理者のみ操作可能（adminAddress 一致チェック）
- 編集可能フィールド（Firebase のみ）: 説明、所在地、メンバー数、ロゴURL、ウェブサイト、連絡先メール、担当者名
- EAS データ（名前、管理者アドレス）は不変
- モーダル or インラインフォームでの編集

#### FR-DAO-05: My DAO一覧

- 接続ウォレットに紐付くDAOのみ表示
- ウォレット未接続時の接続案内
- DAO作成へのショートカット

#### FR-DAO-06: My DAO管理

- 管理者権限チェック
- タブ切り替え:
  - 基礎情報
  - ドキュメント管理
- DAO編集機能
- ドキュメント登録・一覧・管理

#### FR-DAO-07: DAO非活性化

- 管理者のみ操作可能（adminAddress 一致チェック）
- 確認ダイアログ（DAO名の入力による確認）
- 処理: Firebase メタデータの `status` を `"inactive"` に変更
- EAS アテステーションはオンチェーンで不変のため削除不可（アテステーション自体は残存し、オンチェーンで検証可能）
- 紐付きドキュメントの EAS アテステーションも同様に残存
- 非活性化した DAO は公開一覧（`/daos`）に表示されない
- My DAO 一覧には `inactive` ラベル付きで表示（再活性化を可能にするため）
- ※ `PUT /api/daos/[id]` でステータス変更として実装（物理削除は行わない）

---

### 1.3 ドキュメント管理

#### FR-DOC-01: ドキュメント登録

- 入力項目:
  - ドキュメントタイトル（必須）
  - ドキュメントタイプ（articles/assembly_rules/operation_rules/token_rules/custom_rules/proposal/minutes）— **EAS v3 スキーマにオンチェーン保存**
  - ファイル（必須、10MB上限、PDF のみ）
  - 前バージョンUID（規程類は自動設定、その他は常に 0x0）
- バージョン番号はフォームから削除。`previousVersionId` チェーンの深さから自動導出（Firebase キャッシュに保持）
- 登録フロー:
  1. SHA-256 ハッシュ計算
  2. IPFS アップロード
  3. EAS アテステーション作成（Document v3 スキーマ — `version` フィールドなし）
  4. Firebase 同期（`/api/sync/:uid`、ベストエフォート）
- documentType はオンチェーンに固定される（v1 のタイトル推測方式を廃止）
- カテゴリ体系は [document-categories.md](./document-categories.md) に準拠
- 各ステップの進捗表示（0-100%）

#### FR-DOC-02: ドキュメント一覧

- DAO に紐付くドキュメントの一覧
- ドキュメントタイプ別の分類表示
- 各ドキュメントの情報: タイトル、タイプ、バージョン、登録日
- IPFS ダウンロードリンク
- ステータス表示（active/revoked）

#### FR-DOC-03: ドキュメント検証

- ファイルアップロードによるハッシュ照合
- オンチェーンのハッシュとの比較
- 検証結果の表示:
  - 一致時: 登録者アドレス、登録日時、ドキュメントタイプ、IPFS CID を併せて表示
  - 不一致時: 不一致である旨とオンチェーンのハッシュ値を表示

#### FR-DOC-04: ドキュメント失効

- EAS revoke による失効処理
- 管理者のみ操作可能
- 確認ダイアログ
- 失効後のステータス更新

#### FR-DOC-05: ドキュメントダウンロード

- IPFS ゲートウェイ経由でのファイルダウンロード
- ダウンロードリンク: `https://gateway.pinata.cloud/ipfs/{CID}`
- ファイル名の復元: Firebase に保存された `fileName` をダウンロード時のファイル名として使用
- ゲートウェイ接続エラー時のフォールバックメッセージ表示
- 失効済みドキュメントもダウンロード可能（EAS アテステーションが revoked でも IPFS 上のファイルは存在する）

---

### 1.4 共通UI

#### FR-UI-01: ナビゲーション

- メインナビゲーションバー
- ウォレット接続状態表示
- ウォレット接続状態表示
- レスポンシブ対応（モバイルハンバーガーメニュー）

#### FR-UI-02: レスポンシブデザイン

- 320px〜1920px 対応
- モバイルファーストアプローチ
- タッチターゲット 44px 以上

#### FR-UI-03: ダークモード

- システム設定連動
- 手動切替トグル
- 全ページ・全コンポーネント対応

#### FR-UI-04: エラーハンドリング

- グローバルエラーバウンダリ
- 404 ページ
- API エラーの toast 通知
- フォームバリデーションエラー表示

#### FR-UI-05: Homeページ

- ヒーローセクション: サービスタイトル、概要説明、DAO一覧へのCTAボタン
- 統計表示: 登録DAO数、登録ドキュメント数（EAS から取得）
- 機能紹介セクション: 文書登録・検証・公開の概要説明
- レスポンシブ対応

---

## 2. v2 新機能

### 2.1 ドキュメントバージョン管理UI [P0 — Alpha必須]

#### FR-VER-01: バージョンチェーン表示

- `previousVersionId` を辿ったバージョン履歴のタイムライン表示
- 各バージョンの情報: タイトル、バージョン番号、登録日、登録者
- 最新バージョンのハイライト
- ※v1/v2 両方の EAS スキーマに `previousVersionId` が存在するため、UIの追加のみ

#### FR-VER-02: バージョン比較

- 2つのバージョン間のメタデータ比較（タイトル、タイプ等）
- IPFS リンクの並列表示
- ハッシュの差異表示

#### FR-VER-03: バージョン登録

- 既存ドキュメントの「新バージョン登録」ボタン
- 前バージョンUID の自動入力
- バージョン番号の自動インクリメント提案

---

### 2.2 基本ダッシュボード [P0 — Alpha必須]

#### FR-DASH-01: 統計カード

- 管理DAO数
- 登録ドキュメント総数
- 最近の登録数（直近7日/30日）
- 総アテステーション数

#### FR-DASH-02: 最近のアクティビティ

- 直近のアテステーション一覧（作成・失効）
- タイムライン形式の表示
- DAO名・ドキュメント名へのリンク

#### FR-DASH-03: クイックアクション

- DAO作成へのショートカット
- ドキュメント登録へのショートカット
- My DAO一覧へのリンク

---

### 2.3 投票議題管理 [P0 — Alpha必須]

#### FR-VDOC-01: 投票議題登録

- 投票に関連する議案書のアップロード
- 通常のドキュメント登録フロー（ハッシュ計算→IPFS→EASアテステーション）に加え、以下のトランザクション情報を **EAS v3 スキーマでオンチェーンに保存**:
  - votingTxHash（bytes32、必須）— 投票トランザクションハッシュ
  - votingChainId（uint256、必須）— 投票が実行されたチェーンID
- ドキュメントタイプ `proposal` を EAS アテステーションの documentType フィールドに記録
- votingContract, proposalId は txHash + chainId からオンチェーンで追跡可能なため、スキーマには含めない
- ※ 投票 TX リンクはすべてオンチェーンに固定される（オンチェーンアンカリング原則、architecture.md §0.1）
- **UIフロー**: 通常の DocumentRegisterForm で documentType に `proposal` を選択すると、votingTxHash / votingChainId の入力フィールドが条件表示される（独立した専用フォームではなく、同一フォームの条件分岐として実装）

#### FR-VDOC-02: トランザクション情報表示

- 投票議題の詳細画面でリンク済みトランザクション情報を表示
- トランザクションハッシュから Etherscan（またはブロックエクスプローラー）へのリンク生成
- ブロック番号・タイムスタンプの表示（オンチェーンから取得可能な場合）
- トランザクションの存在・有効性の簡易検証

#### FR-VDOC-03: 投票議題一覧・フィルター

- DAO のドキュメント一覧でドキュメントタイプ `proposal` によるフィルタリング
- トランザクションハッシュによる検索
- 投票議題専用のカード表示（トランザクション情報のサマリー付き）

---

### 2.4 EAS スキーマ・後方互換 [P0 — Alpha必須]

#### FR-SCHEMA-01: Document v3 スキーマデプロイ [完了]

- Sepolia テストネットに Document v3 スキーマをデプロイ済み
- スキーマ定義: `bytes32 daoAttestationUID, string documentTitle, string documentType, bytes32 documentHash, string ipfsCid, bytes32 previousVersionId, bytes32 votingTxHash, uint256 votingChainId`
- v2 からの差分: `version` (string) フィールドを削除（`previousVersionId` チェーンから導出する方式に変更）
- カテゴリ ID を合同会社型 DAO 準拠の体系に変更（[document-categories.md](./document-categories.md) 参照）
- スキーマ UID: `0xc1c9b4dc5dedd27304df8b5d564f618a32ec007daebb4022a6059f31e393f51a`（`config/chains.ts` に設定済み）

#### FR-COMPAT-01: v1/v2 アテステーション後方互換

- 現在の実装では v1/v2 はスコープ外（テストデータのみのためマイグレーション不要）
- v3 スキーマのみをクエリ対象としている
- 将来的に v1/v2 後方互換が必要になった場合は、GraphQL エイリアスで複数スキーマを同時クエリする方式で対応可能

---

### 2.5 メンバー管理強化 [P1 — Post-Alpha]

#### FR-MEM-01: メンバーリスト

- DAO ごとのメンバー一覧
- ロール表示（admin/editor/viewer）
- ウォレットアドレス表示

#### FR-MEM-02: ロールベースアクセス制御

- admin: 全操作可能
- editor: ドキュメント登録・編集可能
- viewer: 閲覧のみ

#### FR-MEM-03: 招待フロー

- ウォレットアドレスによるメンバー追加
- 招待リンク生成（将来）

---

### 2.6 マルチチェーン基盤 [P1 — Post-Alpha]

#### FR-CHAIN-01: チェーン設定抽象化

- チェーンID、RPC URL、EAS コントラクトアドレスの設定ファイル
- チェーンごとのスキーマUID管理
- Alpha では Sepolia のみ、構造だけ用意

#### FR-CHAIN-02: ネットワーク切替UI

- 対応チェーンの選択ドロップダウン
- 現在のチェーン表示
- ※Alpha では Sepolia 固定

---

### 2.7 通知システム [P2 — 将来]

#### FR-NOTIF-01: イベント通知

- 新規ドキュメント登録時の通知
- ドキュメント失効時の通知
- メンバー追加時の通知
- ブラウザ通知 or メール通知

---

## 3. 非機能要件

### 3.1 パフォーマンス

| 指標                   | 目標                      |
| ---------------------- | ------------------------- |
| 初回ロード時間（LCP）  | 2.5秒以下                 |
| DAO一覧表示            | 1秒以下（キャッシュあり） |
| Lighthouse Performance | 80+                       |
| バンドルサイズ         | First Load JS 200KB以下   |

### 3.2 品質

| 指標                   | 目標     |
| ---------------------- | -------- |
| テストカバレッジ       | 80% 以上 |
| TypeScript strict mode | 有効     |
| ESLint エラー          | 0        |
| ビルド成功率           | 100%     |

### 3.3 セキュリティ

| 要件               | 詳細                                           |
| ------------------ | ---------------------------------------------- |
| 認証               | ウォレット接続による認証（クライアントサイド） |
| API バリデーション | 全APIルートで Zod スキーマバリデーション       |
| 環境変数           | サーバーサイドのみ、クライアント非露出         |
| CORS               | 適切な Origin 制限                             |
| CSP                | Content Security Policy ヘッダー設定           |
| 依存関係           | `npm audit` で高以上の脆弱性ゼロ               |

### 3.4 アクセシビリティ

| 要件                     | 詳細                                   |
| ------------------------ | -------------------------------------- |
| Lighthouse Accessibility | 90+                                    |
| キーボードナビゲーション | 全インタラクティブ要素で対応           |
| スクリーンリーダー       | ARIA ラベル・ロール適切設定            |
| カラーコントラスト       | WCAG AA 準拠（4.5:1以上）              |
| フォーカス管理           | モーダル・フォームのフォーカストラップ |

### 3.5 レスポンシブデザイン

| ブレークポイント | 幅            | 対応                          |
| ---------------- | ------------- | ----------------------------- |
| モバイル         | 320px〜767px  | 1カラム、ハンバーガーメニュー |
| タブレット       | 768px〜1023px | 2カラム                       |
| デスクトップ     | 1024px〜      | フルレイアウト                |

### 3.6 CI/CD

| 要件               | 詳細                            |
| ------------------ | ------------------------------- |
| CI トリガー        | push to main, PR to main        |
| CI ジョブ          | lint → typecheck → test → build |
| プレビューデプロイ | PR ごとに Vercel プレビュー     |
| 本番デプロイ       | タグプッシュ時に Vercel 本番    |
| コードカバレッジ   | CI でカバレッジレポート生成     |

### 3.7 ドキュメント

| ドキュメント        | 内容                                      |
| ------------------- | ----------------------------------------- |
| README.md           | プロジェクト概要、セットアップ、使い方    |
| CONTRIBUTING.md     | コーディング規約、PR プロセス、テスト方法 |
| SECURITY.md         | 脆弱性報告手順                            |
| CODE_OF_CONDUCT.md  | 行動規範                                  |
| CHANGELOG.md        | リリース履歴                              |
| docs/DEVELOPMENT.md | ローカル開発環境構築手順                  |
| .env.example        | 環境変数テンプレート                      |

---

## 4. Alpha スコープまとめ

### 含む（v0.2.0-alpha）

| カテゴリ         | 機能                                   |
| ---------------- | -------------------------------------- |
| 認証             | ウォレット接続のみ                     |
| DAO管理          | CRUD全操作                             |
| ドキュメント管理 | 登録・一覧・検証・失効                 |
| バージョン管理   | バージョン履歴UI [NEW]                 |
| 投票議題         | TX紐付き議案書管理 [NEW]               |
| ダッシュボード   | 基本統計・アクティビティ [NEW]         |
| EASスキーマ      | Document v3 スキーマデプロイ済み [NEW] |
| UI/UX            | レスポンシブ、ダークモード             |
| 品質             | テスト80%+、CI/CD                      |
| ドキュメント     | OSS公開用ドキュメント一式              |

### 含まない（Post-Alpha）

| カテゴリ                 | 理由                              |
| ------------------------ | --------------------------------- |
| E2E テスト               | 後回し（ユニット/統合テスト優先） |
| メンバー管理（P1）       | Alpha後の拡張                     |
| マルチチェーン実装（P1） | 設定基盤のみAlpha                 |
| 通知システム（P2）       | Alpha後の拡張                     |
| i18n                     | 日本語のみでAlpha                 |
